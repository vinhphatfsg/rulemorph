name: release-cli

on:
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  update-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Extract version from tag
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Extracted version: ${VERSION}"

      - name: Update Cargo.toml files
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          for TOML in crates/rulemorph/Cargo.toml \
                      crates/rulemorph_cli/Cargo.toml \
                      crates/rulemorph_mcp/Cargo.toml \
                      crates/rulemorph_endpoint/Cargo.toml \
                      crates/rulemorph_trace/Cargo.toml \
                      crates/rulemorph_server/Cargo.toml \
                      crates/rulemorph_ui/Cargo.toml; do
            sed -i "s/^version = \".*\"/version = \"${VERSION}\"/" "$TOML"
            echo "Updated $TOML to version ${VERSION}"
          done

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Update Cargo.lock
        run: cargo update -w

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add crates/*/Cargo.toml Cargo.lock
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: bump version to ${{ steps.version.outputs.version }}"
            git push origin main
          fi

  publish-crates-io:
    needs: update-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: cargo publish -p rulemorph

  build-and-upload:
    needs: update-version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-15-intel
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: crates/rulemorph_ui/ui/package-lock.json

      - name: Build UI assets
        working-directory: crates/rulemorph_ui/ui
        run: |
          npm ci
          npm run build

      - name: Build
        run: |
          cargo build -p rulemorph_cli --release --locked --target ${{ matrix.target }}
          cargo build -p rulemorph_mcp --release --locked --target ${{ matrix.target }}
          cargo build -p rulemorph_server --features embedded-ui --release --locked --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        env:
          VERSION: ${{ github.ref_name }}
          TARGET: ${{ matrix.target }}
        run: |
          set -euo pipefail
          BIN_CLI="rulemorph"
          BIN_MCP="rulemorph-mcp"
          BIN_SERVER="rulemorph-server"
          OUT_DIR="dist"
          STAGING="staging"
          SERVER_STAGING="server-staging"
          MCPB_DIR="mcpb-staging"
          UI_DIR="crates/rulemorph_ui/ui/dist"
          mkdir -p "$OUT_DIR" "$STAGING" "$SERVER_STAGING" "$MCPB_DIR"

          # CLI package (tar.gz)
          cp "target/${TARGET}/release/${BIN_CLI}" "$STAGING/"
          cp "target/${TARGET}/release/${BIN_MCP}" "$STAGING/"
          tar -C "$STAGING" -czf "${OUT_DIR}/${BIN_CLI}-${VERSION}-${TARGET}.tar.gz" "$BIN_CLI" "$BIN_MCP"

          # Server package (tar.gz)
          cp "target/${TARGET}/release/${BIN_SERVER}" "$SERVER_STAGING/"
          tar -C "$SERVER_STAGING" -czf "${OUT_DIR}/${BIN_SERVER}-${VERSION}-${TARGET}.tar.gz" "$BIN_SERVER"

          # MCPB package (.mcpb = ZIP)
          VERSION_NUM="${VERSION#v}"
          sed "s/VERSION_PLACEHOLDER/${VERSION_NUM}/" mcp/manifest.json.template > "$MCPB_DIR/manifest.json"
          cp "target/${TARGET}/release/${BIN_MCP}" "$MCPB_DIR/"
          cd "$MCPB_DIR"
          zip -r "../${OUT_DIR}/${BIN_MCP}-${VERSION}-${TARGET}.mcpb" .

      - name: Package (Windows)
        if: runner.os == 'Windows'
        env:
          VERSION: ${{ github.ref_name }}
          TARGET: ${{ matrix.target }}
        shell: pwsh
        run: |
          $BinCli = 'rulemorph.exe'
          $BinMcp = 'rulemorph-mcp.exe'
          $BinServer = 'rulemorph-server.exe'
          $OutDir = 'dist'
          $Staging = 'staging'
          $ServerStaging = 'server-staging'
          $McpbDir = 'mcpb-staging'
          $UiDir = 'crates/rulemorph_ui/ui/dist'
          New-Item -ItemType Directory -Force -Path $OutDir | Out-Null
          New-Item -ItemType Directory -Force -Path $Staging | Out-Null
          New-Item -ItemType Directory -Force -Path $ServerStaging | Out-Null
          New-Item -ItemType Directory -Force -Path $McpbDir | Out-Null

          # CLI package (zip)
          Copy-Item "target\$env:TARGET\release\$BinCli" "$Staging\$BinCli"
          Copy-Item "target\$env:TARGET\release\$BinMcp" "$Staging\$BinMcp"
          Compress-Archive -Path "$Staging\$BinCli","$Staging\$BinMcp" -DestinationPath "$OutDir\rulemorph-$env:VERSION-$env:TARGET.zip"

          # Server package (zip)
          Copy-Item "target\$env:TARGET\release\$BinServer" "$ServerStaging\$BinServer"
          Compress-Archive -Path "$ServerStaging\\$BinServer" -DestinationPath "$OutDir\\rulemorph-server-$env:VERSION-$env:TARGET.zip"

          # MCPB package (.mcpb = ZIP)
          $VersionNum = $env:VERSION.TrimStart('v')
          (Get-Content mcp/manifest.json.template) -replace 'VERSION_PLACEHOLDER', $VersionNum | Set-Content "$McpbDir\manifest.json"
          Copy-Item "target\$env:TARGET\release\$BinMcp" "$McpbDir\$BinMcp"
          Compress-Archive -Path "$McpbDir\*" -DestinationPath "$OutDir\rulemorph-mcp-$env:VERSION-$env:TARGET.mcpb"

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-mcp-registry:
    needs: build-and-upload
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.ref_name }}
      REPO_URL: https://github.com/${{ github.repository }}
    steps:
      - uses: actions/checkout@v4

      - name: Download .mcpb files and compute SHA256
        run: |
          set -euo pipefail

          download_with_retry() {
            local url="$1"
            local output="$2"
            local max_attempts=10
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt: Downloading $url..."
              if curl -L -f -o "$output" "$url"; then
                echo "Download successful"
                return 0
              fi
              echo "Attempt $attempt failed, retrying in 5 seconds..."
              sleep 5
              attempt=$((attempt + 1))
            done
            echo "Failed to download after $max_attempts attempts"
            return 1
          }

          for TARGET in aarch64-apple-darwin x86_64-apple-darwin x86_64-unknown-linux-gnu x86_64-pc-windows-msvc; do
            FILENAME="rulemorph-mcp-${VERSION}-${TARGET}.mcpb"
            URL="${REPO_URL}/releases/download/${VERSION}/${FILENAME}"
            download_with_retry "$URL" "$FILENAME"
            SHA=$(sha256sum "$FILENAME" | cut -d' ' -f1)
            TARGET_VAR=$(echo "$TARGET" | tr '-' '_')
            echo "SHA256_${TARGET_VAR}=${SHA}" >> $GITHUB_ENV
            echo "SHA256 for ${TARGET}: ${SHA}"
          done

      - name: Update server.json with version and SHA256
        run: |
          set -euo pipefail
          VERSION_NUM="${VERSION#v}"
          jq --arg v "$VERSION_NUM" \
             --arg repo_url "$REPO_URL" \
             --arg sha_arm "$SHA256_aarch64_apple_darwin" \
             --arg sha_intel "$SHA256_x86_64_apple_darwin" \
             --arg sha_linux "$SHA256_x86_64_unknown_linux_gnu" \
             --arg sha_win "$SHA256_x86_64_pc_windows_msvc" \
             '.version = $v |
              .packages[0].identifier = $repo_url + "/releases/download/v" + $v + "/rulemorph-mcp-v" + $v + "-aarch64-apple-darwin.mcpb" |
              .packages[0].fileSha256 = $sha_arm |
              .packages[1].identifier = $repo_url + "/releases/download/v" + $v + "/rulemorph-mcp-v" + $v + "-x86_64-apple-darwin.mcpb" |
              .packages[1].fileSha256 = $sha_intel |
              .packages[2].identifier = $repo_url + "/releases/download/v" + $v + "/rulemorph-mcp-v" + $v + "-x86_64-unknown-linux-gnu.mcpb" |
              .packages[2].fileSha256 = $sha_linux |
              .packages[3].identifier = $repo_url + "/releases/download/v" + $v + "/rulemorph-mcp-v" + $v + "-x86_64-pc-windows-msvc.mcpb" |
              .packages[3].fileSha256 = $sha_win' \
             server.json > server.json.tmp
          mv server.json.tmp server.json
          echo "Updated server.json:"
          cat server.json

      - name: Download mcp-publisher
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/modelcontextprotocol/registry/releases/latest | jq -r '.tag_name')
          echo "Downloading mcp-publisher ${LATEST_TAG}"
          curl -L "https://github.com/modelcontextprotocol/registry/releases/download/${LATEST_TAG}/mcp-publisher_linux_amd64.tar.gz" | tar xz mcp-publisher
          chmod +x mcp-publisher

      - name: Publish to MCP Registry
        run: |
          ./mcp-publisher login github-oidc
          ./mcp-publisher publish

  update-homebrew:
    needs: build-and-upload
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.ref_name }}
      REPO_URL: https://github.com/${{ github.repository }}
    steps:
      - name: Download release assets and compute SHA256
        run: |
          set -euo pipefail

          download_with_retry() {
            local url="$1"
            local output="$2"
            local max_attempts=10
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt: Downloading $url..."
              if curl -L -f -o "$output" "$url"; then
                echo "Download successful"
                return 0
              fi
              echo "Attempt $attempt failed, retrying in 5 seconds..."
              sleep 5
              attempt=$((attempt + 1))
            done
            echo "Failed to download after $max_attempts attempts"
            return 1
          }

          for TARGET in aarch64-apple-darwin x86_64-apple-darwin x86_64-unknown-linux-gnu; do
            FILENAME="rulemorph-${VERSION}-${TARGET}.tar.gz"
            URL="${REPO_URL}/releases/download/${VERSION}/${FILENAME}"
            download_with_retry "$URL" "$FILENAME"
            SHA=$(sha256sum "$FILENAME" | cut -d' ' -f1)
            TARGET_VAR=$(echo "$TARGET" | tr '-' '_')
            echo "SHA256_${TARGET_VAR}=${SHA}" >> $GITHUB_ENV
            echo "SHA256 for ${TARGET}: ${SHA}"
          done

          for TARGET in aarch64-apple-darwin x86_64-apple-darwin x86_64-unknown-linux-gnu; do
            FILENAME="rulemorph-server-${VERSION}-${TARGET}.tar.gz"
            URL="${REPO_URL}/releases/download/${VERSION}/${FILENAME}"
            download_with_retry "$URL" "$FILENAME"
            SHA=$(sha256sum "$FILENAME" | cut -d' ' -f1)
            TARGET_VAR=$(echo "$TARGET" | tr '-' '_')
            echo "SERVER_SHA256_${TARGET_VAR}=${SHA}" >> $GITHUB_ENV
            echo "Server SHA256 for ${TARGET}: ${SHA}"
          done

      - name: Trigger Homebrew formula update
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.TAP_REPO_TOKEN }}
          repository: vinhphatfsg/homebrew-tap
          event-type: update-formula
          client-payload: |
            {
              "version": "${{ github.ref_name }}",
              "sha256_arm": "${{ env.SHA256_aarch64_apple_darwin }}",
              "sha256_intel": "${{ env.SHA256_x86_64_apple_darwin }}",
              "sha256_linux": "${{ env.SHA256_x86_64_unknown_linux_gnu }}",
              "server_sha256_arm": "${{ env.SERVER_SHA256_aarch64_apple_darwin }}",
              "server_sha256_intel": "${{ env.SERVER_SHA256_x86_64_apple_darwin }}",
              "server_sha256_linux": "${{ env.SERVER_SHA256_x86_64_unknown_linux_gnu }}"
            }
